import asyncio
import logging
from datetime import datetime
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command, CommandStart
from aiogram.types import Message, CallbackQuery, FSInputFile
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from apscheduler.schedulers.asyncio import AsyncIOScheduler
import pytz

# –ù–∞—à–∏ –º–æ–¥—É–ª–∏
from config import BOT_TOKEN, ADMIN_IDS, TIMEZONE, MORNING_REPORT_HOUR, MORNING_REPORT_MINUTE
from database import db
from excel_helper import ExcelGenerator

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –æ—à–∏–±–∫–∏)
logging.basicConfig(level=logging.INFO)

# –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç—ã –±–æ—Ç–∞ –∏ –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞
bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(storage=MemoryStorage())

# –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —É—Ç—Ä–µ–Ω–Ω–∏—Ö –æ—Ç—á–µ—Ç–æ–≤
scheduler = AsyncIOScheduler(timezone=pytz.timezone(TIMEZONE))

# ========== –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø FSM (Finite State Machine) ==========
# –≠—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –ø–æ—à–∞–≥–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±—Ä–æ–Ω–∏
class ReservationStates(StatesGroup):
    waiting_for_date = State()
    waiting_for_table = State()
    waiting_for_name = State()
    waiting_for_phone = State()
    waiting_for_occasion = State()
    waiting_for_time = State()
    waiting_for_guests = State()
    waiting_for_deposit = State()
    waiting_for_search = State()
    waiting_for_deposit_amount = State()
    waiting_for_deposit_reservation_id = State()

# ========== –•–ï–ù–î–õ–ï–†–´ (–æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥) ==========

@dp.message(CommandStart())
async def cmd_start(message: Message):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    user = message.from_user
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    is_admin = 1 if user.id in ADMIN_IDS else 0
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É
    db.add_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name,
        is_admin=is_admin
    )
    
    if is_admin:
        await message.answer(
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞!\n\n"
            "–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ **–ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–†**\n\n"
            "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
            "/add - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –±—Ä–æ–Ω—å\n"
            "/today - –±—Ä–æ–Ω–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n"
            "/search - –ø–æ–∏—Å–∫ –±—Ä–æ–Ω–∏ (–ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É)\n"
            "/table [ID –±—Ä–æ–Ω–∏] [–Ω–æ–≤—ã–π —Å—Ç–æ–ª] - –∏–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞\n"
            "/dep [—Å—É–º–º–∞] [ID –±—Ä–æ–Ω–∏] - —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç\n"
            "/excel - –≤—ã–≥—Ä—É–∑–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ –±—Ä–æ–Ω–∏ –≤ Excel\n"
            "/help - –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ",
            parse_mode="Markdown"
        )
    else:
        await message.answer(
            "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!\n"
            "–í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –±—Ä–æ–Ω—è—Ö.",
            parse_mode="Markdown"
        )

@dp.message(Command("add"))
async def cmd_add(message: Message, state: FSMContext):
    """–ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)"""
    if not db.is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –±—Ä–æ–Ω–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –î–î.–ú–ú.–ì–ì–ì–ì (–Ω–∞–ø—Ä–∏–º–µ—Ä, 25.12.2024):")
    await state.set_state(ReservationStates.waiting_for_date)

@dp.message(ReservationStates.waiting_for_date)
async def process_date(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω–æ–π –¥–∞—Ç—ã"""
    try:
        # –ü—Ä–æ–±—É–µ–º –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤–≤–µ–¥–µ–Ω–Ω—É—é –¥–∞—Ç—É
        date_obj = datetime.strptime(message.text, "%d.%m.%Y")
        formatted_date = date_obj.strftime("%Y-%m-%d")
        
        await state.update_data(date=formatted_date)
        await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å—Ç–æ–ª–∞ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '–ø—Ä–æ–ø—É—Å–∫'):")
        await state.set_state(ReservationStates.waiting_for_table)
    except ValueError:
        await message.answer("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ (–î–î.–ú–ú.–ì–ì–ì–ì):")

@dp.message(ReservationStates.waiting_for_table)
async def process_table(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ —Å—Ç–æ–ª–∞"""
    table = message.text
    if table.lower() == '–ø—Ä–æ–ø—É—Å–∫':
        table = ""
    await state.update_data(table_number=table)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –≥–æ—Å—Ç—è:")
    await state.set_state(ReservationStates.waiting_for_name)

@dp.message(ReservationStates.waiting_for_name)
async def process_name(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–º–µ–Ω–∏ –≥–æ—Å—Ç—è"""
    await state.update_data(guest_name=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:")
    await state.set_state(ReservationStates.waiting_for_phone)

@dp.message(ReservationStates.waiting_for_phone)
async def process_phone(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    await state.update_data(phone=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –ø–æ–≤–æ–¥ –ø–æ—Å–µ—â–µ–Ω–∏—è (–∏–ª–∏ '–ø—Ä–æ–ø—É—Å–∫'):")
    await state.set_state(ReservationStates.waiting_for_occasion)

@dp.message(ReservationStates.waiting_for_occasion)
async def process_occasion(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–≤–æ–¥–∞"""
    occasion = message.text
    if occasion.lower() == '–ø—Ä–æ–ø—É—Å–∫':
        occasion = ""
    await state.update_data(occasion=occasion)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 19:30):")
    await state.set_state(ReservationStates.waiting_for_time)

@dp.message(ReservationStates.waiting_for_time)
async def process_time(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏"""
    await state.update_data(time=message.text)
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π (—á–∏—Å–ª–æ):")
    await state.set_state(ReservationStates.waiting_for_guests)

@dp.message(ReservationStates.waiting_for_guests)
async def process_guests(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≥–æ—Å—Ç–µ–π –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏"""
    try:
        guests = int(message.text)
        if guests <= 0:
            await message.answer("‚ùå –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º —á–∏—Å–ª–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        data = await state.get_data()
        
        # –î–æ–±–∞–≤–ª—è–µ–º –±—Ä–æ–Ω—å –≤ –±–∞–∑—É
        reservation_id = db.add_reservation(
            date=data['date'],
            table_number=data.get('table_number', ''),
            guest_name=data['guest_name'],
            phone=data['phone'],
            occasion=data.get('occasion', ''),
            time=data['time'],
            guests_count=guests
        )
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –±—Ä–æ–Ω–∏
        reservation_text = (
            f"‚úÖ **–ù–æ–≤–∞—è –±—Ä–æ–Ω—å #{reservation_id}**\n\n"
            f"üìÖ –î–∞—Ç–∞: {data['date']}\n"
            f"üïê –í—Ä–µ–º—è: {data['time']}\n"
            f"üë§ –ì–æ—Å—Ç—å: {data['guest_name']}\n"
            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {data['phone']}\n"
            f"üë• –ì–æ—Å—Ç–µ–π: {guests}\n"
            f"üéâ –ü–æ–≤–æ–¥: {data.get('occasion', '–ù–µ —É–∫–∞–∑–∞–Ω')}\n"
            f"ü™ë –°—Ç–æ–ª: {data.get('table_number', '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω')}"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await message.answer(reservation_text, parse_mode="Markdown")
        
        # –ï—Å–ª–∏ –±—Ä–æ–Ω—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        today = datetime.now().strftime("%Y-%m-%d")
        if data['date'] == today:
            await notify_all_users(reservation_text)
        
        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—Ä–æ –¥–µ–ø–æ–∑–∏—Ç
        await message.answer("–•–æ—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–µ–ø–æ–∑–∏—Ç? –ï—Å–ª–∏ –¥–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (—á–∏—Å–ª–æ), –µ—Å–ª–∏ –Ω–µ—Ç - –æ—Ç–ø—Ä–∞–≤—å—Ç–µ '–Ω–µ—Ç':")
        await state.update_data(reservation_id=reservation_id)
        await state.set_state(ReservationStates.waiting_for_deposit)
        
    except ValueError:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ:")

@dp.message(ReservationStates.waiting_for_deposit)
async def process_deposit(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞"""
    data = await state.get_data()
    reservation_id = data['reservation_id']
    
    if message.text.lower() == '–Ω–µ—Ç':
        await message.answer("‚úÖ –ë—Ä–æ–Ω—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –±–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞.")
    else:
        try:
            deposit = int(message.text)
            if deposit < 0:
                await message.answer("‚ùå –°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π. –ë—Ä–æ–Ω—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –±–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞.")
            else:
                db.update_deposit(reservation_id, deposit)
                await message.answer(f"‚úÖ –î–µ–ø–æ–∑–∏—Ç {deposit}‚ÇΩ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏ #{reservation_id}")
                
                # –ï—Å–ª–∏ –±—Ä–æ–Ω—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - –æ–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–æ–∑–∏—Ç–µ
                today = datetime.now().strftime("%Y-%m-%d")
                if data['date'] == today:
                    reservation = db.get_reservations_by_date(today)
                    for res in reservation:
                        if res[0] == reservation_id:
                            deposit_text = f"\nüí∞ –î–µ–ø–æ–∑–∏—Ç: {deposit}‚ÇΩ"
                            await notify_all_users(f"üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏ #{reservation_id}{deposit_text}")
                    break
        except ValueError:
            await message.answer("‚ùå –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –∏–ª–∏ '–Ω–µ—Ç'. –ë—Ä–æ–Ω—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –±–µ–∑ –¥–µ–ø–æ–∑–∏—Ç–∞.")
    
    await state.clear()

@dp.message(Command("today"))
async def cmd_today(message: Message):
    """–ü–æ–∫–∞–∑–∞—Ç—å –±—Ä–æ–Ω–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è"""
    if not db.is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    reservations = db.get_today_reservations()
    
    if not reservations:
        await message.answer("üì≠ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –±—Ä–æ–Ω–µ–π –Ω–µ—Ç.")
        return
    
    text = "**üìã –ë—Ä–æ–Ω–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:**\n\n"
    for res in reservations:
        text += (
            f"üÜî #{res[0]}\n"
            f"üïê {res[6]} | üë§ {res[3]}\n"
            f"üìû {res[4]} | üë• {res[7]} —á–µ–ª.\n"
            f"ü™ë –°—Ç–æ–ª: {res[2] if res[2] else '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}\n"
            f"üí∞ –î–µ–ø–æ–∑–∏—Ç: {res[8] if len(res) > 8 else 0}‚ÇΩ\n"
            f"-----------------\n"
        )
    
    await message.answer(text, parse_mode="Markdown")

@dp.message(Command("search"))
async def cmd_search(message: Message, state: FSMContext):
    """–ü–æ–∏—Å–∫ –±—Ä–æ–Ω–µ–π"""
    if not db.is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    await message.answer("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–ª–∏ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞:")
    await state.set_state(ReservationStates.waiting_for_search)

@dp.message(ReservationStates.waiting_for_search)
async def process_search(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞"""
    search_term = message.text
    results = db.search_reservations(search_term)
    
    if not results:
        await message.answer("‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await state.clear()
        return
    
    text = f"**üîç –ù–∞–π–¥–µ–Ω–æ {len(results)} –±—Ä–æ–Ω–µ–π:**\n\n"
    for res in results:
        text += (
            f"üÜî #{res[0]}\n"
            f"üìÖ {res[1]} | üïê {res[6]}\n"
            f"üë§ {res[3]} | üìû {res[4]}\n"
            f"ü™ë –°—Ç–æ–ª: {res[2] if res[2] else '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}\n"
            f"-----------------\n"
        )
    
    await message.answer(text, parse_mode="Markdown")
    await state.clear()

@dp.message(Command("table"))
async def cmd_change_table(message: Message):
    """–ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Å—Ç–æ–ª–∞: /table [ID –±—Ä–æ–Ω–∏] [–Ω–æ–≤—ã–π —Å—Ç–æ–ª]"""
    if not db.is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    try:
        parts = message.text.split(maxsplit=2)
        if len(parts) < 3:
            await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /table [ID –±—Ä–æ–Ω–∏] [–Ω–æ–≤—ã–π —Å—Ç–æ–ª]")
            return
        
        reservation_id = int(parts[1])
        new_table = parts[2]
        
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏ –¥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        reservations = db.search_reservations(str(reservation_id))
        reservation = next((r for r in reservations if r[0] == reservation_id), None)
        
        if not reservation:
            await message.answer(f"‚ùå –ë—Ä–æ–Ω—å #{reservation_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return
        
        old_table = reservation[2] if reservation[2] else "–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω"
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–ª
        db.update_table_number(reservation_id, new_table)
        
        await message.answer(f"‚úÖ –°—Ç–æ–ª –¥–ª—è –±—Ä–æ–Ω–∏ #{reservation_id} –∏–∑–º–µ–Ω–µ–Ω: '{old_table}' ‚Üí '{new_table}'")
        
        # –ï—Å–ª–∏ –±—Ä–æ–Ω—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - —É–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö
        today = datetime.now().strftime("%Y-%m-%d")
        if reservation[1] == today:
            await notify_all_users(
                f"üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏ #{reservation_id}\n"
                f"ü™ë –ù–æ–≤—ã–π —Å—Ç–æ–ª: {new_table}"
            )
            
    except ValueError:
        await message.answer("‚ùå ID –±—Ä–æ–Ω–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")

@dp.message(Command("dep"))
async def cmd_deposit(message: Message, state: FSMContext):
    """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–µ–ø–æ–∑–∏—Ç–∞: /dep [—Å—É–º–º–∞] [ID –±—Ä–æ–Ω–∏]"""
    if not db.is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    try:
        parts = message.text.split()
        if len(parts) == 1:
            await message.answer("‚ùå –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /dep [—Å—É–º–º–∞] [ID –±—Ä–æ–Ω–∏]")
            return
        
        if len(parts) == 2:
            # –¢–æ–ª—å–∫–æ —Å—É–º–º–∞ - —Å–ø—Ä–æ—Å–∏–º ID
            amount = int(parts[1])
            await state.update_data(deposit_amount=amount)
            await message.answer("–í–≤–µ–¥–∏—Ç–µ ID –±—Ä–æ–Ω–∏:")
            await state.set_state(ReservationStates.waiting_for_deposit_reservation_id)
        else:
            # –ï—Å—Ç—å –∏ —Å—É–º–º–∞ –∏ ID
            amount = int(parts[1])
            reservation_id = int(parts[2])
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±—Ä–æ–Ω–∏
            reservations = db.search_reservations(str(reservation_id))
            reservation = next((r for r in reservations if r[0] == reservation_id), None)
            
            if not reservation:
                await message.answer(f"‚ùå –ë—Ä–æ–Ω—å #{reservation_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                return
            
            db.update_deposit(reservation_id, amount)
            await message.answer(f"‚úÖ –î–µ–ø–æ–∑–∏—Ç {amount}‚ÇΩ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏ #{reservation_id}")
            
            # –ï—Å–ª–∏ –±—Ä–æ–Ω—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - —É–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö
            today = datetime.now().strftime("%Y-%m-%d")
            if reservation[1] == today:
                await notify_all_users(
                    f"üí∞ –î–µ–ø–æ–∑–∏—Ç –¥–ª—è –±—Ä–æ–Ω–∏ #{reservation_id}\n"
                    f"–°—É–º–º–∞: {amount}‚ÇΩ"
                )
                
    except ValueError:
        await message.answer("‚ùå –°—É–º–º–∞ –∏ ID –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏.")
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {e}")

@dp.message(ReservationStates.waiting_for_deposit_reservation_id)
async def process_deposit_reservation_id(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ ID –±—Ä–æ–Ω–∏ –¥–ª—è –¥–µ–ø–æ–∑–∏—Ç–∞"""
    try:
        reservation_id = int(message.text)
        data = await state.get_data()
        amount = data['deposit_amount']
        
        reservations = db.search_reservations(str(reservation_id))
        reservation = next((r for r in reservations if r[0] == reservation_id), None)
        
        if not reservation:
            await message.answer(f"‚ùå –ë—Ä–æ–Ω—å #{reservation_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            await state.clear()
            return
        
        db.update_deposit(reservation_id, amount)
        await message.answer(f"‚úÖ –î–µ–ø–æ–∑–∏—Ç {amount}‚ÇΩ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–ª—è –±—Ä–æ–Ω–∏ #{reservation_id}")
        
        # –ï—Å–ª–∏ –±—Ä–æ–Ω—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è - —É–≤–µ–¥–æ–º–ª—è–µ–º –≤—Å–µ—Ö
        today = datetime.now().strftime("%Y-%m-%d")
        if reservation[1] == today:
            await notify_all_users(
                f"üí∞ –î–µ–ø–æ–∑–∏—Ç –¥–ª—è –±—Ä–æ–Ω–∏ #{reservation_id}\n"
                f"–°—É–º–º–∞: {amount}‚ÇΩ"
            )
            
    except ValueError:
        await message.answer("‚ùå ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
    finally:
        await state.clear()

@dp.message(Command("excel"))
async def cmd_excel(message: Message):
    """–í—ã–≥—Ä—É–∑–∫–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏—Ö –±—Ä–æ–Ω–µ–π –≤ Excel"""
    if not db.is_admin(message.from_user.id):
        await message.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã.")
        return
    
    reservations = db.get_today_reservations()
    
    if not reservations:
        await message.answer("üì≠ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –±—Ä–æ–Ω–µ–π –Ω–µ—Ç.")
        return
    
    today = datetime.now().strftime("%Y-%m-%d")
    filepath = ExcelGenerator.create_reservation_file(reservations, today)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    document = FSInputFile(filepath)
    await message.answer_document(document, caption=f"üìä –ë—Ä–æ–Ω–∏ –Ω–∞ {today}")

# ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ==========

async def notify_all_users(text: str):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º"""
    users = db.get_all_users()
    for user_id in users:
        try:
            await bot.send_message(user_id, text, parse_mode="Markdown")
        except Exception as e:
            logging.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")

async def send_morning_report():
    """–û—Ç–ø—Ä–∞–≤–∫–∞ —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞ –≤ 11:00"""
    today = datetime.now().strftime("%Y-%m-%d")
    reservations = db.get_today_reservations()
    
    if not reservations:
        text = f"üìã **–£—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—á–µ—Ç {today}**\n\n–ù–∞ —Å–µ–≥–æ–¥–Ω—è –±—Ä–æ–Ω–µ–π –Ω–µ—Ç."
    else:
        text = f"üìã **–£—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—á–µ—Ç {today}**\n\n"
        for res in reservations:
            text += (
                f"üïê {res[6]} | üë§ {res[3]}\n"
                f"üìû {res[4]} | üë• {res[7]} —á–µ–ª.\n"
                f"ü™ë –°—Ç–æ–ª: {res[2] if res[2] else '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}\n"
                f"üí∞ –î–µ–ø–æ–∑–∏—Ç: {res[8] if len(res) > 8 else 0}‚ÇΩ\n"
                f"-----------------\n"
            )
    
    await notify_all_users(text)

# ========== –ó–ê–ü–£–°–ö –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê ==========

async def on_startup():
    """–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞"""
    # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –æ—Ç—á–µ—Ç–∞
    scheduler.add_job(
        send_morning_report,
        'cron',
        hour=MORNING_REPORT_HOUR,
        minute=MORNING_REPORT_MINUTE,
        id='morning_report'
    )
    scheduler.start()
    logging.info(f"–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω. –£—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—á–µ—Ç –≤ {MORNING_REPORT_HOUR}:{MORNING_REPORT_MINUTE:02d}")

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞"""
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é on_startup –∫–∞–∫ –≤—ã–ø–æ–ª–Ω—è–µ–º—É—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    dp.startup.register(on_startup)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())